# image:
#   name: docker/compose:1.24.0
#   entrypoint: ["/bin/sh", "-c"]

# variables:
#   DOCKER_HOST: tcp://docker:2375/
#   DOCKER_DRIVER: overlay2

# services:
#   - docker:dind

# stages:
#   - build
#   - test
#   - acceptance

# build:
#   stage: build
#   script:
#     - docker build . -t ${CI_REGISTRY_IMAGE}:latest
#     - echo ${CI_JOB_TOKEN} | docker login --password-stdin -u ${CI_REGISTRY_USER} ${CI_REGISTRY}
#     - docker push ${CI_REGISTRY_IMAGE}:latest

# acceptance:
#   stage: acceptance
#   script:
#     - echo ${CI_JOB_TOKEN} | docker login --password-stdin -u ${CI_REGISTRY_USER} ${CI_REGISTRY}
#     - docker-compose up --abort-on-container-exit --exit-code-from acceptance


---
stages:
  - docker
  - acceptance

build_image:
 stage: docker
 image: docker:latest
 variables:
   DOCKER_DRIVER: overlay2
 services:
   - docker:dind
 script:
   - echo ${CI_JOB_TOKEN} | docker login --password-stdin -u ${CI_REGISTRY_USER} ${CI_REGISTRY}
   - docker build . -t ${CI_REGISTRY_IMAGE}:latest
   - docker push ${CI_REGISTRY_IMAGE}:latest

acceptance:
 image: cabify/challenge:latest
 stage: acceptance
 only:
   - master
 dependencies: []
 services:
   - name: ${CI_REGISTRY_IMAGE}:latest
     alias: pooling
 script:
   - /harness --address http://pooling:9091 acceptance
